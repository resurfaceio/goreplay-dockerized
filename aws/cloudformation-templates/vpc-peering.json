{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Deploys both a VPC and a VPC peering connection",
  "Parameters": {
    "ResurfaceVPCCIDRBlock": {
      "Type": "String",
      "Description": "Enter a CIDR to create a new VPC for Resurface. Must not overlap with the CIDR block of the selected VPC",
      "AllowedPattern": "^[0-9]{0,3}\\.[0-9]{0,3}\\.[0-9]{0,3}\\.[0-9]{0,3}\\/[0-3]?[0-9]$",
      "ConstraintDescription": "must be a valid CIDR block (xxx.xxx.xxx.xxx/xx)"
    },
    "VPCID": {
      "Type": "AWS::EC2::VPC::Id",
      "Description": "Select the VPC in which your EC2 instance resides. This VPC is to be peered with a new Resurface VPC"
    },
    "RouteTableID": {
      "Type": "String",
      "Description": "Enter the ID of the Route Table associated with the subnet in which your EC2 instance resides"
    }
  },
  "Resources": {
    "ResurfaceVPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": { "Ref": "ResurfaceVPCCIDRBlock" },
        "EnableDnsHostnames": "true",
        "EnableDnsSupport": "true"
      }
    },
    "ResurfaceIG": {
      "Type": "AWS::EC2::InternetGateway"
    },
    "ResurfaceVPCGatewayAttachment": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "InternetGatewayId": { "Ref": "ResurfaceIG" },
        "VpcId": { "Ref": "ResurfaceVPC" }
      }
    },
    "ResurfaceVPCPeeringConnection": {
      "Type" : "AWS::EC2::VPCPeeringConnection",
      "Properties" : {
        "PeerVpcId" : { "Ref": "ResurfaceVPC" },
        "VpcId" : { "Ref": "VPCID" }
      }
    },
    "RouteToResurfaceVPC": {
      "Type" : "AWS::EC2::Route",
      "Properties" : {
        "DestinationCidrBlock" : { "Ref": "ResurfaceVPCCIDRBlock" },
        "RouteTableId" : { "Ref": "RouteTableID" },
        "VpcPeeringConnectionId" : { "Ref": "ResurfaceVPCPeeringConnection" }
      }
    }
  }
}
